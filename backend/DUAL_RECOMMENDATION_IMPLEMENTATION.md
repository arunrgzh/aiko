# Реализация системы двойных рекомендаций вакансий

## Обзор

Система двойных рекомендаций предоставляет пользователям два блока персонализированных вакансий:

1. **Персональные рекомендации** - на основе данных онбординга (анкеты)
2. **Рекомендации по тесту** - на основе результатов профессионального тестирования

Все рекомендации проходят через **инклюзивные фильтры** (`accept_handicapped`) и другие обязательные критерии.

## Архитектура системы

### 1. Компоненты Backend

#### EnhancedHeadHunterService (`backend/app/services/enhanced_headhunter_service.py`)

-   **Основной сервис** для получения двойных рекомендаций
-   **Инклюзивные фильтры**: автоматически добавляет `label=accept_handicapped`
-   **Параллельные запросы**: одновременно получает данные из HH API для обоих блоков
-   **Детальная информация**: автоматически загружает подробности топ-вакансий через `/vacancies/{id}`

```python
# Основной метод
async def get_dual_recommendations(user, db, page=0, per_page=20) -> Dict[str, List[EnhancedRecommendation]]

# Возвращает:
{
    "personal": [EnhancedRecommendation, ...],     # На основе онбординга
    "assessment": [EnhancedRecommendation, ...]    # На основе тестирования
}
```

#### Алгоритм скоринга

**Для персональных рекомендаций:**

-   Совпадение навыков: 40%
-   Совпадение локации: 20%
-   Совпадение зарплаты: 20%
-   Совпадение опыта: 20%

**Для рекомендаций по тесту:**

-   Совпадение сильных сторон: 40%
-   Соответствие уровню: 30%
-   Потенциал роста: 10%
-   Локация: 10%
-   Зарплата: 10%

#### Инклюзивные фильтры

```python
def _add_inclusive_filters(params, onboarding_profile):
    # Обязательный фильтр инклюзивности
    params["label"] = "accept_handicapped"

    # Казахстан по умолчанию
    if "area" not in params:
        params["area"] = "40"

    # Только активные вакансии
    params["archived"] = "false"

    # Адаптации рабочего места
    if onboarding_profile.accessibility_adaptations:
        # Добавляет поисковые термины: "доступная среда", "гибкий график", "удаленная работа"
```

### 2. API Endpoints (`backend/app/api/enhanced_jobs.py`)

#### Основной endpoint

```http
GET /api/enhanced-jobs/dual-recommendations
```

**Параметры:**

-   `page` - номер страницы (по умолчанию 0)
-   `per_page` - количество на страницу (максимум 50)
-   `refresh` - принудительное обновление

**Ответ:**

```json
{
    "personal_block": {
        "source": "onboarding",
        "title": "Персональные рекомендации",
        "description": "Вакансии, подобранные на основе ваших предпочтений и опыта из анкеты",
        "recommendations": [...],
        "total_found": 15
    },
    "assessment_block": {
        "source": "assessment",
        "title": "Рекомендации на основе тестирования",
        "description": "Дополнительные вакансии, подобранные на основе результатов вашего профессионального тестирования",
        "recommendations": [...],
        "total_found": 8
    },
    "user_has_assessment": true,
    "total_recommendations": 23,
    "generated_at": "2024-01-15T10:30:00Z"
}
```

#### Детали вакансии

```http
GET /api/enhanced-jobs/vacancy/{vacancy_id}
```

Возвращает полную информацию о вакансии с HH API, включая:

-   Полное описание
-   Контактную информацию (если есть)
-   Ссылку для отклика на hh.ru

#### Ручные триггеры

```http
POST /api/enhanced-jobs/trigger-update              # Обновить для текущего пользователя
POST /api/enhanced-jobs/admin/trigger-batch-update  # Обновить для всех пользователей (админ)
GET /api/enhanced-jobs/task-status/{task_id}        # Статус задачи
```

### 3. Автоматические задачи (`backend/app/tasks/job_recommendations.py`)

#### Celery Tasks

**Обновление рекомендаций:**

-   **Частота**: каждый час
-   **Условие**: нет обновлений за последние 6 часов
-   **Лимит**: до 20 рекомендаций на пользователя

**Очистка старых данных:**

-   **Частота**: ежедневно
-   **Удаляет**: рекомендации старше 30 дней

#### Запуск Celery

```bash
# Worker
celery -A celery_app worker --loglevel=info --queues=job_recommendations,maintenance

# Beat Scheduler
celery -A celery_app beat --loglevel=info

# Monitoring
celery -A celery_app flower
```

### 4. Frontend компонент (`front/src/components/jobs/DualJobRecommendations.tsx`)

#### Возможности

-   **Два блока рекомендаций** с четким разделением
-   **Объяснение источника** для каждой вакансии
-   **Детальные оценки** совпадений
-   **Модальное окно** с полной информацией о вакансии
-   **Действия**: сохранить, откликнуться, перейти на hh.ru
-   **Призыв к действию** для прохождения теста (если не пройден)

#### Использование

```tsx
import DualJobRecommendations from '@/components/jobs/DualJobRecommendations'

// В компоненте страницы
;<DualJobRecommendations />
```

## Процесс работы системы

### 1. Пользователь проходит онбординг

-   Сохраняются предпочтения: регион, должность, зарплата, навыки
-   Генерируется краткое резюме

### 2. (Опционально) Пользователь проходит тест

-   Сохраняются сильные стороны и рекомендуемые профессии
-   Определяется целевая профобласть

### 3. Сервер формирует запросы к HH API

**Запрос 1 (на основе анкеты):**

```python
params = {
    "text": "python OR javascript OR дизайн",  # Навыки + профессия
    "area": "160,159",                       # Предпочитаемые города
    "salary": 200000,                        # Минимальная зарплата
    "employment": "full,part",               # Тип занятости
    "label": "accept_handicapped",           # ОБЯЗАТЕЛЬНЫЙ фильтр
    "archived": "false"
}
```

**Запрос 2 (на основе теста):**

```python
params = {
    "text": "программист OR аналитик OR менеджер",  # Из сильных сторон
    "area": "160,159",                             # Из анкеты
    "salary": 200000,                              # Из анкеты
    "label": "accept_handicapped",                 # ОБЯЗАТЕЛЬНЫЙ фильтр
    "archived": "false"
}
```

### 4. Обработка результатов

-   Получение списков вакансий (JSON)
-   Обработка пагинации и лимитов
-   Для топ-N вакансий: вызов детального `/vacancies/{id}`
-   Извлечение нужных полей

### 5. Отображение результатов

**Блок 1: Персональные вакансии**

-   Совпадают с интересами из анкеты
-   Помечены как "на основе анкеты"

**Блок 2: Дополнительные рекомендации**

-   По результатам теста
-   Помечены как "на основе теста"
-   Объяснение причины показа

### 6. Действия пользователя

-   **Клик на вакансию**: показ полного текста в модальном окне
-   **Сохранить**: добавление в избранное
-   **Откликнуться**: переход на hh.ru по `alternate_url`

## Ключевые особенности

### ✅ Инклюзивность

-   **Все** вакансии проходят фильтр `accept_handicapped`
-   Поддержка адаптаций рабочего места
-   Поиск по ключевым словам доступности

### ✅ Персонализация

-   Двойной алгоритм рекомендаций
-   Учет результатов тестирования
-   Непрерывное обучение на основе обратной связи

### ✅ Производительность

-   Параллельные запросы к HH API
-   Кэширование рекомендаций
-   Автоматическое обновление по расписанию

### ✅ Прозрачность

-   Объяснение каждой рекомендации
-   Детальные оценки совпадений
-   Четкое разделение источников

## Конфигурация

### Environment Variables

```env
# Celery
CELERY_BROKER_URL=redis://REDACTED:6379/0
CELERY_RESULT_BACKEND=redis://REDACTED:6379/0

# HeadHunter API
HH_API_BASE_URL=https://api.hh.kz
HH_USER_AGENT=AI-Komekshi Job Platform Parser
```

### Redis Setup

```bash
# Установка Redis
sudo apt install redis-server

# Запуск
redis-server

# Проверка
redis-cli ping
```

## Мониторинг и логирование

### Логи

-   Все операции логируются с уровнем INFO/ERROR
-   Отдельные логи для каждого пользователя
-   Метрики производительности HH API

### Мониторинг задач

```bash
# Flower UI
celery -A celery_app flower

# Доступ: http://REDACTED:5555
```

### Метрики

-   Количество обновленных рекомендаций
-   Время выполнения запросов к HH API
-   Успешность задач Celery
-   Количество ошибок

## Развертывание

### 1. Установка зависимостей

```bash
pip install celery redis flower
```

### 2. Настройка Redis

```bash
sudo systemctl start redis
sudo systemctl enable redis
```

### 3. Запуск сервисов

```bash
# Backend API
uvicorn app.main:app --reload

# Celery Worker
celery -A celery_app worker --loglevel=info

# Celery Beat
celery -A celery_app beat --loglevel=info

# Flower (опционально)
celery -A celery_app flower
```

### 4. Проверка работы

```bash
# Тест API
curl -X GET "http://REDACTED:8000/api/enhanced-jobs/dual-recommendations" \
     -H "Authorization: Bearer YOUR_TOKEN"

# Тест задач
curl -X POST "http://REDACTED:8000/api/enhanced-jobs/trigger-update" \
     -H "Authorization: Bearer YOUR_TOKEN"
```

## Возможные улучшения

### 🚀 Краткосрочные

-   Добавление фильтров по отраслям
-   Интеграция с календарем для планирования откликов
-   Push-уведомления о новых рекомендациях

### 🚀 Долгосрочные

-   ML-модель для улучшения скоринга
-   Интеграция с другими job-платформами
-   Автоматическое составление резюме
-   Система рейтинга работодателей

## Поддержка

При возникновении проблем:

1. Проверьте логи Celery и API
2. Убедитесь в работе Redis
3. Проверьте доступность HH API
4. Проверьте корректность токенов аутентификации

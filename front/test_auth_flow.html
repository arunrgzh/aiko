<!doctype html>
<html>
    <head>
        <title>Test NextAuth Flow</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .test-section {
                margin: 20px 0;
                padding: 15px;
                border: 1px solid #ddd;
            }
            .result {
                margin: 10px 0;
                padding: 10px;
                background: #f5f5f5;
                white-space: pre-wrap;
            }
            button {
                padding: 10px 15px;
                margin: 5px;
                background: #007bff;
                color: white;
                border: none;
                cursor: pointer;
            }
            .error {
                background: #ffebee;
                color: #c62828;
            }
            .success {
                background: #e8f5e9;
                color: #2e7d32;
            }
        </style>
    </head>
    <body>
        <h1>üîê NextAuth Token Flow Test</h1>

        <div class="test-section">
            <h2>1. Direct Backend Test</h2>
            <button onclick="testBackendAuth()">Test Backend Login</button>
            <div id="backend-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. NextAuth Session Test</h2>
            <button onclick="checkNextAuthSession()">
                Check NextAuth Session
            </button>
            <div id="session-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. NextAuth Credentials Login</h2>
            <button onclick="testNextAuthLogin()">Test NextAuth Login</button>
            <div id="nextauth-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>4. API Call with NextAuth Token</h2>
            <button onclick="testProtectedAPI()">Test Protected API</button>
            <div id="api-result" class="result"></div>
        </div>

        <script>
            // Test 1: Direct backend authentication
            async function testBackendAuth() {
                const result = document.getElementById('backend-result')
                try {
                    const response = await fetch(
                        'http://localhost:8000/api/auth/login',
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username: 'testuser123',
                                password: 'testpassword123',
                            }),
                        },
                    )

                    if (response.ok) {
                        const data = await response.json()
                        result.className = 'result success'
                        result.textContent = `‚úÖ Backend login successful!\nAccess Token: ${data.access_token.slice(0, 30)}...\nRefresh Token: ${data.refresh_token.slice(0, 30)}...\nFirst Login: ${data.is_first_login}`
                    } else {
                        result.className = 'result error'
                        result.textContent = `‚ùå Backend login failed: ${response.status} ${await response.text()}`
                    }
                } catch (error) {
                    result.className = 'result error'
                    result.textContent = `‚ùå Backend error: ${error.message}`
                }
            }

            // Test 2: Check NextAuth session
            async function checkNextAuthSession() {
                const result = document.getElementById('session-result')
                try {
                    const response = await fetch('/api/auth/session')
                    const session = await response.json()

                    result.className = 'result'
                    result.textContent = `NextAuth Session:\n${JSON.stringify(session, null, 2)}`

                    if (session?.accessToken) {
                        result.className = 'result success'
                        result.textContent = `‚úÖ Session has access token!\n${JSON.stringify(session, null, 2)}`
                    } else {
                        result.className = 'result error'
                        result.textContent = `‚ùå Session missing access token!\n${JSON.stringify(session, null, 2)}`
                    }
                } catch (error) {
                    result.className = 'result error'
                    result.textContent = `‚ùå Session check error: ${error.message}`
                }
            }

            // Test 3: NextAuth credentials login
            async function testNextAuthLogin() {
                const result = document.getElementById('nextauth-result')
                try {
                    // This would normally be done through NextAuth's signIn function
                    // For testing, we'll try to call the credentials provider directly
                    const response = await fetch(
                        '/api/auth/callback/credentials',
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type':
                                    'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                username: 'testuser123',
                                password: 'testpassword123',
                                callbackUrl: window.location.origin,
                            }),
                        },
                    )

                    result.className = 'result'
                    result.textContent = `NextAuth login response: ${response.status}\n${await response.text()}`
                } catch (error) {
                    result.className = 'result error'
                    result.textContent = `‚ùå NextAuth login error: ${error.message}`
                }
            }

            // Test 4: Test protected API with session token
            async function testProtectedAPI() {
                const result = document.getElementById('api-result')
                try {
                    // First get session
                    const sessionResp = await fetch('/api/auth/session')
                    const session = await sessionResp.json()

                    if (!session?.accessToken) {
                        result.className = 'result error'
                        result.textContent =
                            '‚ùå No access token in session. Please login first.'
                        return
                    }

                    // Test protected API
                    const apiResp = await fetch(
                        'http://localhost:8000/main/assistants/',
                        {
                            headers: {
                                Authorization: `Bearer ${session.accessToken}`,
                                'Content-Type': 'application/json',
                            },
                        },
                    )

                    if (apiResp.ok) {
                        const data = await apiResp.json()
                        result.className = 'result success'
                        result.textContent = `‚úÖ Protected API successful!\n${JSON.stringify(data, null, 2)}`
                    } else {
                        result.className = 'result error'
                        result.textContent = `‚ùå Protected API failed: ${apiResp.status}\n${await apiResp.text()}`
                    }
                } catch (error) {
                    result.className = 'result error'
                    result.textContent = `‚ùå Protected API error: ${error.message}`
                }
            }
        </script>

        <div
            style="
                margin-top: 40px;
                padding: 20px;
                background: #f0f8ff;
                border-radius: 5px;
            "
        >
            <h3>üí° How to Use This Test:</h3>
            <ol>
                <li>
                    <strong>Test Backend Auth:</strong> Verifies your backend
                    login works
                </li>
                <li>
                    <strong>Check Session:</strong> Shows what's in your
                    NextAuth session
                </li>
                <li>
                    <strong>Test NextAuth Login:</strong> Tests NextAuth
                    credentials flow
                </li>
                <li>
                    <strong>Test Protected API:</strong> Tests if session token
                    works for API calls
                </li>
            </ol>
            <p>
                <strong>Expected Result:</strong> After proper NextAuth login,
                the session should contain an accessToken that works for API
                calls.
            </p>
        </div>
    </body>
</html>
